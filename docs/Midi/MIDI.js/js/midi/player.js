"undefined"==typeof MIDI&&(MIDI={}),void 0===MIDI.Player&&(MIDI.Player={}),function(){"use strict";var e=MIDI.Player;e.currentTime=0,e.endTime=0,e.restart=0,e.playing=!1,e.timeWarp=1,e.startDelay=0,e.BPM=120,e.start=e.resume=function(n){e.currentTime<-1&&(e.currentTime=-1),l(e.currentTime,null,n)},e.pause=function(){var n=e.restart;m(),e.restart=n},e.stop=function(){m(),e.restart=0,e.currentTime=0},e.addListener=function(e){o=e},e.removeListener=function(){o=void 0},e.clearAnimation=function(){e.animationFrameId&&cancelAnimationFrame(e.animationFrameId)},e.setAnimation=function(n){var r=0,t=0,a=0;e.clearAnimation();var o=function(){if(e.animationFrameId=requestAnimationFrame(o),0!==e.endTime){e.playing?(r=a===e.currentTime?t-Date.now():0,r=0===e.currentTime?0:e.currentTime-r,a!==e.currentTime&&(t=Date.now(),a=e.currentTime)):r=e.currentTime;var c=e.endTime,u=r/1e3,s=u/60,l=60*s+(u-60*s),m=c/1e3;m-l<-1||n({now:l,end:m,events:i})}};requestAnimationFrame(o)},e.loadMidiFile=function(n,r,t){try{e.replayer=new Replayer(MidiFile(e.currentData),e.timeWarp,null,e.BPM),e.data=e.replayer.getData(),e.endTime=s(),MIDI.loadPlugin({onsuccess:n,onprogress:r,onerror:t})}catch(e){t&&t(e)}},e.loadFile=function(n,r,t,a){if(e.stop(),-1!==n.indexOf("base64,")){var i=window.atob(n.split(",")[1]);e.currentData=i,e.loadMidiFile(r,t,a)}else{var o=new XMLHttpRequest;o.open("GET",n),o.overrideMimeType("text/plain; charset=x-user-defined"),o.onreadystatechange=function(){if(4===this.readyState)if(200===this.status){for(var n=this.responseText||"",i=[],o=n.length,c=String.fromCharCode,u=0;u<o;u++)i[u]=c(255&n.charCodeAt(u));var s=i.join("");e.currentData=s,e.loadMidiFile(r,t,a)}else a&&a("Unable to load MIDI file")},o.send()}},e.getFileInstruments=function(){for(var n={},r={},t=0;t<e.data.length;t++){var a=e.data[t][0].event;if("channel"===a.type){var i=a.channel;switch(a.subtype){case"controller":break;case"programChange":r[i]=a.programNumber;break;case"noteOn":var o=r[i];n[MIDI.GM.byId[isFinite(o)?o:i].id]=!0}}}var c=[];for(var u in n)c.push(u);return c};var n,r,t=[],a=0,i={},o=void 0,c=function(r,a,c,u,s,m,d){return setTimeout((function(){var u={channel:r,note:a,now:c,end:e.endTime,message:s,velocity:m};128===s?delete i[a]:i[a]=u,o&&o(u),e.currentTime=c,t.shift(),(t.length<1e3||e.currentTime===n&&n<e.endTime)&&l(n,!0)}),c-u)},u=function(){return"webaudio"===MIDI.api?MIDI.WebAudio.getContext():(e.ctx={currentTime:0},e.ctx)},s=function(){for(var n=e.data,r=n.length,t=.5,a=0;a<r;a++)t+=n[a][1];return t},l=function(i,o,l){if(e.replayer){var d;o||(void 0===i&&(i=e.restart),e.playing&&m(),e.playing=!0,e.data=e.replayer.getData(),e.endTime=s());var f=0,v=0,p=e.data,I=u(),y=p.length;n=.5;t[0]&&t[0].interval;var h=i-e.currentTime;if("webaudio"!==MIDI.api){var T=window.performance&&window.performance.now?window.performance.now():Date.now();r=r||T,I.currentTime=(T-r)/1e3}a=I.currentTime;for(var D=0;D<y&&v<100;D++){var g=p[D];if((n+=g[1])<=i)f=n;else{i=n-f;var M=g[0].event;if("channel"===M.type){var w=M.channel,b=MIDI.channels[w],F=I.currentTime+(i+h+e.startDelay)/1e3,k=n-f+e.startDelay;switch(M.subtype){case"controller":MIDI.setController(w,M.controllerType,M.value,F);break;case"programChange":MIDI.programChange(w,M.programNumber,F);break;case"pitchBend":MIDI.pitchBend(w,M.value,F);break;case"noteOn":if(b.mute)break;d=M.noteNumber-(e.MIDIOffset||0),t.push({event:M,time:k,source:MIDI.noteOn(w,M.noteNumber,M.velocity,F),interval:c(w,d,n+e.startDelay,f-h,144,M.velocity)}),v++;break;case"noteOff":if(b.mute)break;d=M.noteNumber-(e.MIDIOffset||0),t.push({event:M,time:k,source:MIDI.noteOff(w,M.noteNumber,F),interval:c(w,d,n,f-h,128,0)})}}}}l&&l(t)}},m=function(){var n=u();for(e.playing=!1,e.restart+=1e3*(n.currentTime-a);t.length;){var r=t.pop();window.clearInterval(r.interval),r.source&&("number"==typeof r.source?window.clearTimeout(r.source):r.source.disconnect(0))}for(var c in i){r=i[c];144===i[c].message&&o&&o({channel:r.channel,note:r.note,now:r.now,end:r.end,message:128,velocity:r.velocity})}i={}}}();